name: Build and Release

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-native-binaries:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux-x86_64
            runner: [self-hosted, X64]
            target: x86_64-unknown-linux-gnu
            ext: ""
          - platform: macos-arm64
            runner: macos-latest
            target: aarch64-apple-darwin
            ext: ""
          - platform: windows-x86_64
            runner: windows-latest
            target: x86_64-pc-windows-msvc
            ext: ".exe"

    env:
      RUSTY_V8_MIRROR: https://github.com/denoland/rusty_v8/releases/download
      V8_FROM_SOURCE: "0"
      GIT_COMMIT: ${{ github.sha }}
      CARGO_PROFILE_RELEASE_STRIP: debuginfo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config g++ build-essential ca-certificates

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.88.0
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: "true"

      - name: Build compact binary
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }}
          cp ./target/${{ matrix.target }}/release/oramacore${{ matrix.ext }} ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-compact${{ matrix.ext }}

      - name: Build reader-only binary
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --no-default-features --features reader --bin oramacore
          cp ./target/${{ matrix.target }}/release/oramacore${{ matrix.ext }} ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-reader${{ matrix.ext }}

      - name: Build writer-only binary
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} --no-default-features --features writer --bin oramacore
          cp ./target/${{ matrix.target }}/release/oramacore${{ matrix.ext }} ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-writer${{ matrix.ext }}

      - name: Upload binaries to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-compact${{ matrix.ext }}
            ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-reader${{ matrix.ext }}
            ./target/${{ matrix.target }}/release/oramacore-${{ matrix.platform }}-writer${{ matrix.ext }}
          token: ${{ secrets.GITHUB_TOKEN }}

  build-docker-OramaCore-x86_64:
    needs: [build-native-binaries]
    name: Build and Upload Docker Images
    runs-on: [self-hosted, X64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker Setup and Build Steps
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from release tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Determine if this is a release candidate
        id: check_rc
        run: |
          if [[ "${{ steps.get_version.outputs.VERSION }}" == *"-rc."* ]]; then
            echo "is_rc=true" >> $GITHUB_OUTPUT
          else
            echo "is_rc=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push OramaCore x86_64 (stable)
        if: steps.check_rc.outputs.is_rc == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile-oramacore-x86
          platforms: linux/amd64
          push: true
          tags: |
            oramasearch/oramacore:${{ steps.get_version.outputs.VERSION }}
            oramasearch/oramacore:latest

      - name: Build and push OramaCore x86_64 (RC)
        if: steps.check_rc.outputs.is_rc == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile-oramacore-x86
          platforms: linux/amd64
          push: true
          tags: |
            oramasearch/oramacore:${{ steps.get_version.outputs.VERSION }}

  build-docker-OramaCore-arm64:
    needs: [build-native-binaries]
    name: Build and Upload Docker Images
    runs-on: [self-hosted, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker Setup and Build Steps
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract version from release tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Determine if this is a release candidate
        id: check_rc
        run: |
          if [[ "${{ steps.get_version.outputs.VERSION }}" == *"-rc."* ]]; then
            echo "is_rc=true" >> $GITHUB_OUTPUT
          else
            echo "is_rc=false" >> $GITHUB_OUTPUT
          fi

      - name: Build and push OramaCore ARM64 (stable)
        if: steps.check_rc.outputs.is_rc == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile-oramacore-arm64
          platforms: linux/arm64
          push: true
          tags: |
            oramasearch/oramacore-arm64:${{ steps.get_version.outputs.VERSION }}
            oramasearch/oramacore-arm64:latest

      - name: Build and push OramaCore ARM64 (RC)
        if: steps.check_rc.outputs.is_rc == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile-oramacore-arm64
          platforms: linux/arm64
          push: true
          tags: |
            oramasearch/oramacore-arm64:${{ steps.get_version.outputs.VERSION }}
