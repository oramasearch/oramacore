# Stage 1: Build Rust application
FROM rust:1.85-slim-bookworm AS rust-builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
  libssl3 \
  pkg-config \
  libssl-dev \
  g++ \
  build-essential \
  ca-certificates \
  curl \
  git \
  && rm -rf /var/lib/apt/lists/*

ENV RUSTY_V8_MIRROR=https://github.com/denoland/rusty_v8/releases/download
ENV V8_FROM_SOURCE=0

WORKDIR /usr/src/app

# Copy source code
COPY . .

# Build Rust application
RUN cargo build --release

# Stage 2: Runtime image
FROM debian:bookworm-slim

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
  libssl3 \
  ca-certificates \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy compiled Rust binary
COPY --from=rust-builder /usr/src/app/target/release/oramacore /app/

# Copy configuration
COPY --from=rust-builder /usr/src/app/config.yaml /app/

ENV RUST_LOG=oramacore=trace

EXPOSE 8080

CMD ["./oramacore"]
