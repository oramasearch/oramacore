use std::time::Duration;

use anyhow::Result;
use redact::Secret;
use serde_json::json;
use tokio::time::sleep;

use crate::{
    collection_manager::sides::{Offset, WriteOperation},
    tests::utils::{create, create_collection, create_oramacore_config, insert_docs},
    types::{ApiKey, CollectionId},
};

#[tokio::test(flavor = "multi_thread", worker_threads = 10)]
async fn test_delete_documents() -> Result<()> {
    let _ = tracing_subscriber::fmt::try_init();
    let mut config = create_oramacore_config();
    config.reader_side.config.insert_batch_commit_size = 1_000_000;
    config.writer_side.config.insert_batch_commit_size = 1_000_000;

    let (write_side, read_side) = create(config.clone()).await?;

    let collection_id = CollectionId::from("test-collection".to_string());
    create_collection(write_side.clone(), collection_id).await?;

    let document_count = 10;
    insert_docs(
        write_side.clone(),
        ApiKey(Secret::new("my-write-api-key".to_string())),
        collection_id,
        (0..document_count).map(|i| {
            json!({
                "id": i.to_string(),
                "text": "text ".repeat(i + 1),
            })
        }),
    )
    .await?;

    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count);

    write_side
        .delete_documents(
            ApiKey(Secret::new("my-write-api-key".to_string())),
            collection_id,
            vec![(document_count - 1).to_string()],
        )
        .await?;
    sleep(Duration::from_millis(100)).await;
    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 1);

    write_side.commit().await.unwrap();
    read_side.commit().await.unwrap();

    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 1);

    write_side
        .delete_documents(
            ApiKey(Secret::new("my-write-api-key".to_string())),
            collection_id,
            vec![(document_count - 2).to_string()],
        )
        .await?;
    sleep(Duration::from_millis(100)).await;

    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 2);

    let (write_side, read_side) = create(config.clone()).await?;
    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 1);

    write_side
        .delete_documents(
            ApiKey(Secret::new("my-write-api-key".to_string())),
            collection_id,
            vec![(document_count - 2).to_string()],
        )
        .await?;
    sleep(Duration::from_millis(500)).await;

    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 2);

    write_side.commit().await.unwrap();
    read_side.commit().await.unwrap();

    let (_, read_side) = create(config.clone()).await?;
    let result = read_side
        .search(
            ApiKey(Secret::new("my-read-api-key".to_string())),
            collection_id,
            json!({
                "term": "text",
            })
            .try_into()?,
        )
        .await?;
    assert_eq!(result.count, document_count - 2);

    // Deletion of non-existent document should not fail
    let output = write_side
        .delete_documents(
            ApiKey(Secret::new("my-write-api-key".to_string())),
            collection_id,
            vec![(document_count - 2).to_string()],
        )
        .await;
    assert!(output.is_ok());

    Ok(())
}

#[tokio::test(flavor = "multi_thread", worker_threads = 10)]
async fn test_bug_delete_documents() -> Result<()> {
    let a = r#"{"CreateCollection":{"id":"my-coll","read_api_key":"read","description":null,"default_language":"english"}}
{"Collection":["my-coll",{"CreateField":{"field_id":0,"field_name":"___orama_auto_embedding","field":{"Embedding":{"model":"BGESmall","document_fields":[1,null]}}}}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":0,"doc":["xl36ihhwk2m0a0fyumu2tzv6","{\"title\":\"title 1\",\"bool\":true,\"number\":1,\"id\":\"xl36ihhwk2m0a0fyumu2tzv6\"}"]}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":1,"field_name":"title","field":{"Text":"EN"}}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":2,"field_name":"title","field":"String"}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":3,"field_name":"number","field":"Number"}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":4,"field_name":"bool","field":"Bool"}}]}
{"Collection":["my-coll",{"Index":[0,2,{"IndexStringFilter":{"value":"title 1"}}]}]}
{"Collection":["my-coll",{"Index":[0,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[0,4,{"IndexBoolean":{"value":true}}]}]}
{"Collection":["my-coll",{"Index":[0,1,{"IndexString":{"field_length":2,"terms":{"titl":{"positions":[0]},"1":{"positions":[1]},"title":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":1,"doc":["rpco3pi9ms10gm65ej3ps51u","{\"title\":\"title 2\",\"bool\":true,\"number\":1,\"id\":\"rpco3pi9ms10gm65ej3ps51u\"}"]}}]}
{"Collection":["my-coll",{"Index":[1,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[1,4,{"IndexBoolean":{"value":true}}]}]}
{"Collection":["my-coll",{"Index":[1,2,{"IndexStringFilter":{"value":"title 2"}}]}]}
{"Collection":["my-coll",{"Index":[1,1,{"IndexString":{"field_length":2,"terms":{"title":{"positions":[0]},"2":{"positions":[1]},"titl":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":2,"doc":["tgpzi53xwpta97vtkk80p7mf","{\"title\":\"title 3\",\"bool\":true,\"number\":1,\"id\":\"tgpzi53xwpta97vtkk80p7mf\"}"]}}]}
{"Collection":["my-coll",{"Index":[2,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[2,2,{"IndexStringFilter":{"value":"title 3"}}]}]}
{"Collection":["my-coll",{"Index":[2,4,{"IndexBoolean":{"value":true}}]}]}
{"Collection":["my-coll",{"Index":[2,1,{"IndexString":{"field_length":2,"terms":{"titl":{"positions":[0]},"title":{"positions":[0]},"3":{"positions":[1]}}}}]}]}
{"Collection":["my-coll",{"Index":[0,0,{"IndexEmbedding":{"value":[-0.11278465,-0.044251874,0.053479802,-0.526689,-0.44006902,0.25337636,-0.10965382,0.41064504,0.44664142,-0.19030485,-0.1835556,-0.52681106,0.2962022,-0.12035231,0.11066229,0.071884155,0.066628195,0.042866275,-0.8966841,0.18686329,0.7720079,-0.47750577,-0.058084313,-0.12570883,-0.28388005,-0.17114477,-0.25781804,-0.33942345,-0.17885381,-1.204723,-0.04457682,-0.41917384,0.99641556,-0.0112257,0.09697966,-0.2229375,-0.34522733,0.19003157,-0.43748474,0.35289556,0.5054821,0.29360685,0.3864025,-0.24431437,-0.39097455,-0.5837513,-0.42887184,0.47400457,0.5097018,-0.13944773,-0.49363568,0.10903931,0.1361488,0.39224035,0.58226985,0.17006059,0.21205,-0.33947614,0.1340013,-0.1877067,0.27920255,0.21060528,-1.6043812,0.43543035,0.08904336,0.21533065,-0.31855705,-0.41450083,-0.2712874,0.1748907,0.04185616,-0.2460615,0.13100642,0.44341487,0.004370256,-0.007985548,0.22673173,-0.543568,-0.29336703,-0.1733036,-0.46691063,-0.42944336,-0.18848628,-0.526517,-0.14449553,-0.2188901,0.20988464,-0.19610457,0.41144907,0.21095137,-0.31053302,0.12676516,0.17967485,-0.14290024,-0.7437411,0.16567507,-0.012982455,0.21716863,-0.16268851,1.1106179,-0.51035935,0.18336625,0.012031902,-0.67087626,1.0918857,-0.18844076,0.4859203,-0.8367476,0.027890986,-0.11892874,0.29158643,-0.007285725,0.9364291,-0.4553944,0.20963357,0.048040565,0.31273997,0.10366093,-0.13554482,-0.13393357,0.23790811,0.030512722,-0.06502585,-0.14727783,-0.03477894,0.082820676,0.35308838,0.75561523,-0.09738714,0.7809837,0.60315496,0.20200486,-0.056714058,-0.1868522,0.022594105,0.40366986,-0.3017807,0.47399834,0.018897664,-0.27981567,-0.21802382,-0.72727275,-0.46979037,-0.6314697,-0.4079132,0.31462434,0.07192221,0.08455901,-0.23793654,0.20578142,-0.49566096,0.86727625,-0.27467486,-0.015619451,0.19649436,-0.087095,0.3116996,0.8098616,-0.39134634,0.17619497,0.09919531,-0.75523794,0.21333903,1.2702304,0.47606105,-0.5439481,0.09663703,-0.0083064595,-0.38412753,0.07221759,-0.024394989,-0.08242624,-0.46024945,-0.35682786,0.57210195,0.14642282,0.08318121,-0.099191144,-0.013241595,0.266037,-0.23857775,-0.09098747,-0.16223387,0.11808777,0.36444646,0.034068715,-0.420732,-0.33498046,0.26506183,0.16221653,-0.31814823,0.0023633784,-0.24753918,-0.55232656,-0.19192053,-0.14915155,0.05690488,-0.33139524,0.06374359,-0.49962547,1.8100142,0.12092989,-0.14377247,-0.06819985,-0.08767579,0.35181218,0.14348532,0.048539855,-0.26890704,0.13078135,0.11952834,0.28580266,0.2799641,-0.28612173,-0.2599224,-0.009513855,0.4573531,0.04373169,0.025669444,0.3256366,-0.26572683,-0.18200822,-0.18911673,-2.000666,0.47035912,0.04166343,-0.8686302,-0.7967252,0.14663349,0.6878551,-0.43595192,0.7599959,0.32667682,0.84374446,0.052171186,-0.32603037,0.06487179,0.13990568,0.13298918,-0.57366943,0.5276212,0.19748063,-0.09275263,-0.6312256,0.021606445,-0.34971341,-0.4980857,0.34771174,-0.07661924,1.2469593,0.3138053,0.2208044,0.16727066,-0.065820694,-0.013026888,-0.081461474,-0.71234965,-0.097616196,0.16499953,-0.49331388,0.31859797,-0.4246937,-0.32411334,0.06658797,-0.10844005,-0.35613805,-0.7381037,-0.2754919,-0.26640797,-0.18967785,-0.15697168,-0.5385132,0.24421138,0.31417847,-0.3429371,0.47624347,0.43763873,0.5569902,-0.35248634,-0.26486275,-0.46709928,-0.07465224,0.04544995,-0.20532781,-0.32982704,0.387859,-0.26627973,0.26701215,0.5508534,-0.22913152,-0.2624935,0.15784489,-0.14346911,-0.4937744,0.017603094,0.24296708,-0.09748147,0.42917842,0.043304443,-0.07912454,0.15143317,-0.2334319,0.06852124,0.11495807,0.18384205,0.672785,0.17954601,0.24931231,-0.097112305,0.21498178,0.5886286,0.23619772,0.15287226,-0.16808294,0.30540326,-0.10512647,-0.33499423,0.50796926,-0.07634735,-2.5894442,0.11233798,-0.1674385,0.5668779,-0.16879949,0.12169612,0.46004972,0.4965765,-0.51869065,0.21142994,-0.43726695,0.3363037,0.25259793,-0.14309415,0.2061296,0.17383403,0.326742,-0.61041814,0.21287364,0.1555807,0.0709173,0.32745025,1.6089755,-0.08420911,0.2759345,0.23226096,0.078019746,0.26402006,0.795388,0.24999167,-0.39612925,0.0685267,1.0464311,-0.21396707,-0.065909125,0.26291674,-0.14137338,0.22108164,0.11231223,0.19832888,-0.18386321,0.18937406,-0.22924943,0.0324114,0.61383057,-0.31441915,0.2804829,-0.1343193,-0.08674474,0.0077542393,-0.19711824,0.11699516,-0.30969515,0.21589245,-0.10470044,0.5412875,0.36767855,-0.3218578,-0.12444895,-0.29142103,-0.10183203,-0.62436193,0.50735265,0.03746865,0.20325002]}}]}]}
{"Collection":["my-coll",{"Index":[1,0,{"IndexEmbedding":{"value":[-0.5239394,-0.14313084,-0.26079983,-0.35091147,-0.32843018,-0.29948595,0.123330645,0.33092245,0.14845446,0.23162672,0.252594,-1.0099013,0.25887045,-0.5623779,0.35526106,0.13326941,0.1080335,0.13352638,-0.26776123,0.24104309,0.74698895,-0.11285146,-0.30205452,-0.15724818,0.10184394,0.24936761,-0.48358494,0.09525384,-0.86834717,-1.2976074,0.0025846693,-0.66101074,0.5150621,0.17503697,0.6284993,-0.30169848,-0.07363701,0.16857062,0.10498556,0.26904976,-0.12249247,0.026597764,0.3166487,-0.19454108,-0.12247043,-0.77737087,-0.21251763,0.3286811,0.6234063,-0.5970595,-0.22850884,0.3489312,0.10155402,0.5258518,0.01615058,0.33609602,0.5107829,-0.11531321,0.765408,-0.1799825,0.4437612,0.26018608,-1.8583984,0.2546624,0.39593506,0.31193033,-0.35342747,-0.17279752,0.17347717,-0.5304396,-0.3137881,0.5069716,0.09239197,0.24815719,-0.28617013,-0.11224397,0.054350536,-0.24801466,-0.28104147,-0.1484464,-0.69052464,0.024136014,-0.3219028,-0.18425158,-0.23171742,-0.5124919,-0.2301712,0.28929308,0.14207289,0.017660247,-0.092301264,-0.37347582,-0.029286703,0.2735935,-0.7003513,0.2880995,-0.1177063,0.52182347,-0.3415663,0.8418443,-0.033224743,-0.13041963,-0.1691759,-0.48035684,0.79348415,-0.017796835,0.12793088,-0.4061258,-0.18209839,-0.26363245,0.1806522,0.4509006,0.9758742,-0.61273533,-0.025354598,0.44188774,0.21302287,0.12873925,-0.24812528,0.10852475,0.12982093,-0.059077397,-0.23724025,-0.36193848,0.19080083,-0.0951004,0.7387017,0.3117201,0.1826494,0.60066056,0.024836222,0.13965924,-0.36094156,-0.16959041,-0.7660319,0.07780949,-0.08689541,0.54912484,0.027061462,-0.10328039,-0.17780049,-0.5353987,-0.7015788,-0.5041775,0.087375216,0.6344774,-0.39372253,0.16279094,-0.059842426,0.35188803,-0.084163666,0.50267196,0.054592557,0.013170878,-0.46162245,-0.23654345,0.32104492,0.4812554,-0.1897816,0.22165044,0.20515019,-0.17797174,0.1613744,1.1456189,0.49974906,-0.71288383,-0.08835009,-0.22922635,-0.25009495,0.048283048,-0.24891493,0.0150625445,-0.1717453,-0.47960746,0.63917375,-0.12340445,0.009190877,0.07340452,0.10771094,0.16917843,-0.17702824,-0.20858257,0.056525335,-0.17066447,0.22453478,-0.28579247,-0.37917075,-0.3448677,-0.19494247,0.3457989,-0.5205934,0.009901974,-0.92141384,-0.34853786,-0.29773712,-0.20007154,0.0007002089,0.07968097,0.04079442,0.1292428,1.4893527,-0.13929325,-0.07496892,0.008084933,0.20860969,0.21864319,0.16167885,0.14276631,-0.7202827,0.06974729,-0.23328887,-0.018200345,0.21341282,-0.7638753,-0.038194127,0.03996277,-0.0393965,0.29156792,-0.03309462,0.39177787,0.012029224,0.11617872,-0.20648023,-1.9983724,0.817315,-0.036742315,-0.48632133,-0.7501492,-0.060131285,0.26533678,-0.046801463,0.4685737,0.16138881,0.92167157,0.16938242,0.2784797,0.27078417,0.09161123,0.3801473,-0.03294966,-0.0041478476,0.18202294,-0.22167589,-0.38400778,0.23457125,-0.0692873,-0.28530872,0.80741376,0.13701715,1.4639486,-0.015729692,-0.43943277,-0.43584865,0.33426073,0.16585796,-0.10680135,-0.7897407,0.6108941,0.08850731,-0.21030681,0.41636574,-0.5483941,-0.16567802,-0.16759746,0.28777397,-0.1244562,-0.24588946,-0.05930498,-0.2632815,0.25599247,0.35357666,-0.56552464,0.64333767,0.622857,0.17812347,0.16824596,0.16245185,0.079383425,0.1538639,-0.24347305,-0.4666036,-0.1622022,0.066999756,-0.21115875,-0.43621486,0.37027678,-0.25678,0.115605034,0.24839443,-0.15373717,-0.20386082,0.49376762,0.03344663,-0.076246895,0.24071757,0.38985696,-0.012339274,0.39590877,0.1264766,0.076852664,-0.20628527,-0.2156745,-0.25327384,-0.058647156,0.33876547,0.5282864,0.48343235,0.30708566,-0.4632653,0.2915802,0.3973931,0.07566452,-0.121539645,-0.31271872,0.41553244,-0.22501966,-0.23308308,0.375156,0.20293172,-2.516059,-0.3256124,-0.0670183,0.3413391,0.21487512,0.40459526,0.28634644,0.05859836,-0.6549072,0.5933838,-0.35090128,0.31224906,0.4341024,0.30663723,-0.30680338,0.4816759,0.10131412,-0.268141,0.08012644,-0.28218332,-0.016177284,-0.034492068,1.5356988,0.16149658,-0.0012656318,0.021252103,-0.24413893,0.40684,0.778795,0.47092015,-0.13779534,0.1740852,1.110867,-0.29778036,-0.13376236,0.2613305,0.015154309,0.16181034,0.067718506,0.09458669,-0.18620822,0.15261501,-0.49884713,-0.12181049,0.4238578,-0.6786126,-0.5710178,-0.03010665,0.31973946,0.39681327,-0.1496084,-0.5381809,-0.43540445,-0.08961783,0.117186226,0.34375,-0.09436205,-0.30428737,-0.330563,-0.34732395,-0.1796075,-0.0669384,0.4473877,0.46956953,0.0648028]}}]}]}
{"Collection":["my-coll",{"Index":[2,0,{"IndexEmbedding":{"value":[-0.17944045,0.10608909,0.10591489,0.032604583,0.040715717,-0.08432516,0.010102771,0.18938047,0.12661779,0.2756144,0.28110975,-0.91998,0.18717302,-0.49704707,0.37155005,0.038566224,-0.3098784,0.030020759,-0.3578751,0.14832632,1.2372117,-0.35171363,0.1717166,-0.022458939,0.04180036,0.028363183,-0.3791068,-0.09834326,-0.4428769,-1.2556967,0.26078287,-0.46488154,0.563029,-0.031266257,0.40094867,-0.17061728,-0.44538808,0.27598935,-0.23497517,0.022284236,-0.1661188,0.32820892,-0.36412993,0.090625584,-0.20305179,-0.47496396,-0.3530186,0.2408302,0.31894648,-0.5226586,-0.27696157,0.24486996,-0.006388142,0.61541164,-0.14342572,0.18035053,0.61345565,-0.23463222,0.25891185,-0.2901059,0.3676438,0.44756788,-1.741676,0.48648906,0.31032598,0.34688896,-0.2775065,-0.2555266,-0.21750405,-0.35015577,-0.65388995,0.6215704,0.25829062,0.61023533,-0.21365793,0.052420843,0.067590624,-0.07602292,-0.56296504,-0.124212176,-0.17016748,-0.33189029,-0.11383275,-0.3372396,-0.43325078,-0.593192,-0.16103399,0.29619527,-0.02546038,0.15790503,-0.48173013,-0.42435127,0.1864504,-0.035813287,-0.28641763,0.22441791,-0.15176538,0.19046819,-0.3251688,1.0150785,-0.33030772,0.033370607,-0.06509799,-0.041559856,0.57814825,0.02615429,0.40362003,-0.3512842,0.10416685,0.064170204,-0.11963762,-0.11141677,1.0451428,-0.6072795,0.06683131,0.42583355,0.49704707,-0.05488114,0.1154549,0.10567765,0.10890561,0.17837307,-0.17200579,-0.017059326,0.10214688,-0.14450364,0.193862,0.48560733,0.48153833,0.6065209,-0.17224248,0.29564822,-0.8031529,-0.26347777,-0.41153622,0.12566993,-0.45417133,0.1728501,-0.34723628,-0.72980607,-0.080445066,-0.739252,-0.5199963,-0.35623896,-0.07346598,0.9458124,-0.27673268,0.39041573,-0.1983381,0.42202324,0.06582787,0.54730517,0.08239165,-0.15856497,-0.124307,-0.05036018,0.3464995,0.62895566,-0.25897217,0.3469645,-0.14867727,-0.52797157,-0.07091377,1.133417,0.45988247,-0.5755964,0.02498772,-0.13029988,-0.21478853,-0.114521936,-0.11813518,-0.07658395,-0.33239165,-0.2652406,0.3012964,-0.21525447,-0.048589796,0.073797315,0.46000525,0.27656883,0.062026612,-0.2650953,-0.0898423,-0.086902075,0.0037711007,-0.2741118,-0.21612331,0.1265159,0.2822629,0.0998913,-0.4568714,0.20244616,-0.21634057,-0.26860192,-0.12362671,-0.44324893,-0.29204887,0.019168671,0.52758497,-0.32660204,1.7026367,-0.040047783,-0.119458154,0.4144752,-0.1861645,0.22079976,0.021693638,-0.6482747,-0.54196894,0.0283927,0.0047981627,0.39393252,0.42913526,-0.24514735,0.24571955,-0.18469808,-0.028351557,0.12765975,0.04771755,0.260344,-0.31690252,0.30597615,-0.41788155,-2.0268788,0.54686046,-0.03728667,-0.46273512,-0.28647795,0.08482574,0.48070708,-0.270425,0.4112084,0.054504395,1.2388625,0.009059724,-0.00092606316,-0.07188779,0.10590926,0.15274356,0.035327002,0.20756094,-0.06294105,-0.0034495762,-0.4325765,0.16761562,-0.67829823,-0.37798238,0.6945336,0.015614827,1.3331938,-0.12770808,0.13010389,-0.3119754,0.31028676,0.33283234,0.16075061,-1.1439965,0.6837914,0.17762248,0.07583618,0.8740583,-0.31560844,-0.3562935,-0.34773764,-0.028589157,0.30110097,-0.4571446,0.04338478,-0.54095167,0.18996465,0.00060962496,-0.3034101,0.40640986,0.37973168,-0.11664254,0.2590085,0.3171503,0.49765742,0.086757295,-0.3854748,-0.17565046,-0.2567124,0.18943714,-0.12928264,-0.44503203,-0.19801149,-0.48887417,-0.20000494,-0.020010812,0.06548469,-0.2426874,0.3379887,0.1406061,-0.28968158,-0.056403022,0.3102039,0.08973912,0.63730586,0.63599795,0.2854916,-0.09685698,0.068244934,-0.20586704,0.002389817,0.33135986,0.47878882,-0.17158218,0.27096558,0.018477304,0.10717537,0.49215263,0.4323556,0.01905314,0.03293355,0.32320875,-0.2716021,-0.31509107,0.8144764,-0.021703085,-2.6148624,0.106462754,-0.33623976,0.10162208,0.04859906,0.5229928,0.14714064,-0.00585774,-0.69489396,0.29283506,-0.70020115,0.6450137,-0.016698565,-0.44700986,0.054656617,0.20525506,0.09366976,-0.39296177,0.0400976,0.088962376,-0.18570383,-0.105545044,1.6690383,0.06590707,0.08800107,-0.1455921,-0.1846248,0.6759905,0.5826416,-0.036065966,-0.18476722,0.021537418,1.093564,-0.177746,0.13229297,0.022330148,0.36268833,0.26619974,0.046348937,-0.19965108,0.25154185,-0.0068635484,-0.087063566,-0.36183384,0.00025703793,-0.510025,-0.23980518,0.13916233,0.06951759,0.30479795,-0.39741445,0.4398891,-0.5646508,-0.10216776,0.40337843,0.695638,-0.07305327,-0.09408569,-0.19488525,-0.37538365,-0.31175885,-0.630536,0.12395731,0.21765591,-0.10228911]}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":3,"doc":["c122z3uzjf7za6jkl8yjpcta","{\"title\":\"The dog is on sofà\",\"id\":\"c122z3uzjf7za6jkl8yjpcta\"}"]}}]}
{"Collection":["my-coll",{"Index":[3,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[3,1,{"IndexString":{"field_length":2,"terms":{"dog":{"positions":[0]},"sofa":{"positions":[1]}}}}]}]}
{"Collection":["my-coll",{"Index":[3,0,{"IndexEmbedding":{"value":[-0.667229,-0.37623537,0.114670105,0.07708305,-0.006451762,0.29030517,-0.027729493,0.57091796,0.7518164,0.52875,0.08400953,-1.2523828,0.09357899,0.2955957,-0.19864258,-0.0056178663,0.5461816,0.22035156,-0.5802707,0.28287354,0.7729272,-0.5161621,0.19724,-0.17352234,-0.089665525,0.13263321,-0.258855,0.04028107,-0.20403087,-0.80891603,0.2292212,-0.55950683,0.65356445,0.10086792,-0.015124054,-0.3178656,0.061494447,0.5175,-0.25500804,0.56061524,0.052565917,0.30682373,-0.24269043,-0.20158936,0.23155273,-0.42007324,-0.85802734,-0.4228369,0.98282224,-0.6058496,-0.45246765,-0.057644043,0.1104779,0.0715033,0.4639746,-0.03054161,0.59478515,0.3917383,0.041642684,0.2248877,0.23158936,0.8459375,-1.3779688,0.8357715,0.23283692,0.07970322,-0.4247876,-0.30138916,0.35071534,0.38526368,-0.18259095,0.2044342,0.25317383,-0.091380924,0.14535889,-0.24706055,-0.26558045,0.22153091,-0.45449218,-0.08931486,-0.3382666,-0.071741946,-0.07995209,-0.28124756,0.09541565,-0.50651366,0.08893234,-0.31680176,-0.1412793,0.38611817,-0.73433596,0.48313478,0.06586258,-0.34558594,-0.31099853,-0.15808922,-0.13525146,-0.3970349,-0.095272824,1.0941894,-0.13799866,0.09555054,0.3623169,-0.4347937,0.8055859,0.15242432,0.32434082,-0.11293442,-0.14478141,0.1822824,-0.06687164,-0.10319305,0.28014892,-0.21889374,0.091484375,0.32268065,-0.077640384,0.05257263,0.30940917,0.3317163,0.1902649,0.0494936,-0.09487915,0.010028,0.48969728,-0.009820805,0.7771094,0.7692871,0.078826904,0.5318799,0.080440216,0.11217407,0.2938159,0.1403479,0.24757622,0.37256348,-0.36396486,0.2670874,-0.006611633,-0.2774939,-0.25042358,-1.0503321,0.33349854,-0.5001221,0.3626758,-0.06367752,-0.20599854,-0.34087646,-0.2715552,-0.26544678,0.08237976,-0.044928588,0.53186524,-0.08806549,-0.16881958,-0.04713196,-0.3580127,0.74850583,-0.34275147,0.05262268,-0.15468994,-0.8238867,0.07745773,0.18490967,0.09337475,-0.1348056,-0.30048737,0.28185302,0.5508496,-0.3247705,0.08956096,0.2968994,-0.87998044,0.043112334,0.10895996,-0.33132812,-0.017322998,0.21667908,-0.010767059,-0.03670143,0.2711035,-0.387771,-0.42259276,0.66616213,-0.21659179,0.25827834,-0.037629854,0.11354126,0.38707215,-0.058964387,0.25735474,0.16318177,-0.11407471,-0.7025391,-0.6383008,-0.24798095,-0.8846875,0.16057557,-0.13285644,-0.07518814,1.578125,-0.25533912,-0.016450806,0.040374756,0.25513062,0.043772966,0.12298893,-0.17782135,-0.20675537,0.29538575,0.634248,-0.14855103,0.32236817,-0.3545459,-0.021689758,0.074794464,-0.38125,0.06994865,0.20104127,0.15955555,-0.2598999,-0.3232666,-0.23238586,-1.9211719,-0.15469971,-0.07896324,-0.4620691,-0.20711869,0.22832702,0.4694922,-0.3043994,1.0205567,-0.037545167,0.862157,-0.43299317,-0.07220398,-0.5469116,-0.14973968,0.6101086,0.18410766,0.04410034,0.37690187,0.12358887,-0.17524506,-0.295625,-0.06493523,-0.079332665,0.29391906,-0.46632934,1.6982422,0.68294924,0.35386962,-0.048793737,0.13587768,0.14728317,-0.38777342,-0.82901365,0.40132812,0.313645,0.4841687,-0.082887575,-0.15244861,-0.4563965,-0.4503711,0.6630371,-0.21883392,-0.8956738,-0.0027172852,0.14577073,-0.08817276,-0.3548767,-0.74232423,-0.19848327,0.2552661,0.49362305,0.076757506,0.38760254,0.115567625,-0.09941803,0.13446526,-0.5632031,-0.35206786,0.14005806,-0.05611389,-0.9279492,0.30735412,-0.5883496,0.53089356,-0.20715515,-0.62539065,-0.22266571,0.11187729,0.05498291,-0.027933808,0.0021463013,0.659707,0.00032226564,0.52593505,-0.23635253,0.08050568,-0.62209964,-0.011796627,-0.071693726,0.19568908,-0.43725097,-0.04488083,-0.22690918,0.23332855,-0.6599707,0.42073974,0.21977234,0.9319043,-0.35663086,0.1703186,-0.014918518,0.057475187,-0.4994232,-0.17663085,0.115185544,-2.4349608,-0.30785644,-0.28936553,0.32536864,-0.02052063,0.03971924,0.27168944,0.1428833,-1.0687696,-0.39236328,-0.75984377,0.5931055,0.15966247,-0.22992054,-0.21483032,0.15262878,0.21823487,-0.04972656,0.24821015,0.05851242,0.34328124,0.12929444,1.9110937,-0.35413086,0.8881836,0.24100585,-0.39090255,0.44032228,0.7286865,-0.13402244,-0.062366944,-0.15065704,0.35453126,-0.4486133,-0.07003716,0.06999878,0.010463944,0.2476449,-0.12865204,-0.42084473,0.2875293,0.6100586,0.2962171,-0.26859558,0.6696045,-0.22728759,-0.09358642,0.008342896,0.027494544,0.50061524,-0.32876953,-0.25205794,-0.689209,0.1818193,-0.015346565,0.77049804,-0.11468747,-0.11750977,-0.085188754,-0.6905176,-0.08485565,-0.64559275,0.7209375,0.3052954,0.5030957]}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":4,"doc":["t13dqg2oz61pmcf9va1f2ysd","{\"title\":\"The dog is on sofà\",\"id\":\"t13dqg2oz61pmcf9va1f2ysd\"}"]}}]}
{"Collection":["my-coll",{"Index":[4,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[4,1,{"IndexString":{"field_length":2,"terms":{"sofa":{"positions":[1]},"dog":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[4,0,{"IndexEmbedding":{"value":[0.077963695,-0.31290108,0.29401508,0.22780064,-0.21436419,-0.103934154,0.18018886,0.6470424,0.7103097,0.25678363,0.15204294,-1.1381139,-0.066054754,0.7481864,-0.12280873,-0.13469587,0.5796596,0.3675014,-0.3851144,0.04361071,-0.04155622,-0.26398578,0.2886832,-0.2220677,-0.28070068,0.015895298,0.06813403,-0.11701747,-0.04134696,-0.95626396,-0.05141994,-0.560791,-0.038539343,-0.11683219,0.1274414,-0.18302917,0.22719029,0.4238979,-0.0001373291,0.2600272,0.08816964,-0.043112617,-0.39861187,-0.45263672,0.1609072,0.09036255,-0.28783306,-0.7416295,0.76000977,-0.2755454,-0.72893417,0.13795362,0.59490097,-0.03993007,0.431536,0.1588658,0.9005999,0.1765747,-0.29654366,0.33646938,0.42836216,0.66741073,-0.6764788,0.9159459,0.14932688,-0.15040806,-0.5076032,-0.0018114363,0.6419329,0.51981026,0.15686907,-0.1434239,-0.053440638,-0.022691999,0.4683315,-0.17876326,0.15776716,0.54268974,-0.23056467,0.2734811,-0.30099052,0.04146903,-0.30873325,-0.14516123,-0.029224942,-0.28517804,0.15414865,-0.62168664,-0.4466727,0.37029156,-0.73113143,0.16589355,-0.323652,-0.3481707,-0.12590681,-0.50938195,-0.05000523,-0.13228934,0.045701165,1.0671387,-0.07259124,0.1935076,0.47265625,-0.7295619,0.2153146,0.20983887,0.412214,0.37515694,0.07397897,0.3022461,-0.5147182,-0.06461007,-0.3295724,0.15665981,-0.025666373,0.5655692,0.24667795,0.28695244,0.5237165,-0.2837677,0.045835223,0.19168417,-0.07333374,-0.19954573,0.39358956,-0.48123604,0.53452843,0.46909878,-0.25615582,0.34296528,0.05114964,-0.53327286,0.7244001,0.05014038,0.34273857,0.48896137,0.007193429,-0.15117645,0.09134347,-0.7518136,-0.40872627,-0.8492606,-0.008684431,-0.5342843,0.49780273,0.32675606,-0.05555943,-0.12079293,-0.3701172,-0.49271065,0.12270682,-0.07385908,0.113568984,-0.22759315,-0.15061733,-0.04093715,-0.7844587,0.92550224,-0.39634487,0.15575518,0.45256695,-0.5160784,0.04638672,-0.09249442,-0.1408517,0.23351778,-0.8805106,0.37392044,0.48496792,0.14591762,0.27675083,0.63860214,-0.94782364,0.6545759,0.18020794,-0.04945646,0.02771868,0.09124102,-0.3334961,-0.010223389,0.49497768,-0.17376709,-0.668178,0.69433594,-0.29331753,0.19888742,-0.15572684,0.2420044,0.22055925,0.16030285,0.34857178,0.26618305,-0.30844116,-0.29814148,-0.48702568,-0.17645264,-1.1180246,0.2411063,-0.13527788,0.4174456,1.3565848,-0.6044573,-0.19573103,0.03344563,0.27355957,-0.0077416557,0.5921456,0.008519853,0.05874198,-0.17800795,0.61711776,0.053639002,-0.2520229,-0.43481445,0.036738805,0.39421734,-0.5984933,-0.20198277,0.59368026,-0.057055335,0.40379116,-0.14054598,0.4351981,-1.5436662,0.32862636,-0.34563336,-0.28809467,-0.4993526,-0.01440944,0.42393276,-0.29609898,0.7106585,-0.4820731,0.27761623,-0.5167585,0.03174264,0.14730398,0.102900915,0.5368129,0.88748604,0.19167219,-0.45347378,0.14776175,0.21573748,-0.17381069,-0.096636094,0.26165336,0.4702846,-0.18413435,1.3706752,0.65761024,0.22565569,-0.10784912,0.54063195,0.09564209,-0.82366073,-1.2780412,-0.1985103,0.66964287,0.40916225,-0.746024,-0.18213041,-0.41666085,-0.50503975,0.7823661,-0.3417271,-0.69328964,-0.029527936,0.2574463,-0.054098945,-0.14927019,-0.6832101,0.21731131,0.6118164,0.70975167,-0.311785,0.42557198,-0.101626806,-0.2402867,0.7952706,-0.64564735,-0.1673584,0.2682495,0.010752542,-0.7781808,0.7826451,-0.16739763,0.19186401,-0.26730782,-0.566476,-0.2849644,0.2088623,0.043779645,-0.35229492,-0.36684746,0.29188755,-0.19485037,0.49829102,-0.37709263,0.3890904,0.31472343,0.23486765,-0.11151559,0.47277832,-0.62248886,0.22632708,-0.12234061,0.024386814,-0.37539238,-0.09777178,-0.45012555,0.78348213,-0.61160713,0.24760437,0.0388031,0.047465734,-0.36322784,-0.34804863,0.5245536,-1.5715681,-0.14909145,-0.34057617,-0.19840786,-0.2672119,-0.30433872,-0.80050224,0.32013813,-0.6557966,-0.6635742,-0.40781948,0.318464,-0.46146065,0.34241596,-0.45969936,0.047927856,0.011581421,0.4885254,0.2562561,-0.122885294,0.117906846,-0.16594587,1.2813895,-0.34395927,0.98751396,0.10291835,-0.5307966,-0.004863194,0.13101251,0.22018869,0.20730045,-0.31002373,0.33831787,-1.0567801,0.14120443,0.03226035,-0.19652449,0.59200615,0.003450666,-0.5419922,0.18932669,0.65046036,-0.16395786,-0.37433735,0.24473354,-0.19519043,0.18755232,0.30862862,-0.13304356,0.58768135,0.17775181,0.008344377,-0.50223213,0.23173305,0.116219655,-0.049983434,-0.22849819,-0.28365654,-0.0279759,-0.5114746,-0.07856969,-0.4407959,0.09870911,0.82299805,0.5433502]}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":5,"doc":["ok1","{\"id\":\"ok1\",\"title\":\"The dog is on sofà\",\"section\":\"home\",\"number\":1}"]}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":5,"field_name":"section","field":{"Text":"EN"}}}]}
{"Collection":["my-coll",{"CreateField":{"field_id":6,"field_name":"section","field":"String"}}]}
{"Collection":["my-coll",{"Index":[5,6,{"IndexStringFilter":{"value":"home"}}]}]}
{"Collection":["my-coll",{"Index":[5,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[5,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[5,5,{"IndexString":{"field_length":1,"terms":{"home":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[5,1,{"IndexString":{"field_length":2,"terms":{"dog":{"positions":[0]},"sofa":{"positions":[1]}}}}]}]}
{"Collection":["my-coll",{"Index":[5,0,{"IndexEmbedding":{"value":[0.2172309,-0.306939,0.24758911,0.03833686,-0.07129499,-0.18205197,0.14820354,0.48293728,0.45298937,0.40196398,-0.0092230905,-0.87852645,0.19251844,0.7051595,0.11478,0.09089491,0.2774387,0.55807835,-0.099544525,0.37197536,-0.06405512,-0.42599827,0.33102375,-0.042899236,-0.020480685,0.14285956,0.24987115,-0.07006158,-0.17411634,-0.8897569,0.1506958,-0.57766384,0.03608534,-0.09964667,0.5076226,-0.06781006,0.18414646,0.38194445,-0.16083442,0.4578315,0.16012233,0.100862294,0.055704754,-0.16312663,0.17900933,0.3106893,-0.025821261,-0.7837999,0.68098956,-0.41402182,-0.48620307,0.095581904,0.09372626,-0.13031006,0.43706596,0.3263143,0.93207467,0.010203044,-0.23934259,0.23452419,0.30187988,0.85215926,-0.9352214,0.7618544,0.5241835,-0.14456517,-0.5089247,-0.05703142,0.9066026,0.42349583,0.19181654,-0.11531915,-0.06488376,-0.26152208,0.5218777,-0.17599148,-0.1258884,0.37618002,-0.27567038,0.081448026,-0.37601724,0.09276581,-0.06562635,-0.18582661,-0.23811848,-0.09690433,0.2799208,-0.54797363,-0.2940945,0.45003256,-0.6713867,-0.0814921,-0.51295304,-0.41124132,-0.29163954,-0.36764866,-0.0116136335,-0.44725206,0.0066452026,1.0361328,0.13201396,0.16207208,0.43907335,-0.81114364,0.31863064,0.335829,0.2620093,0.41878256,-0.073132835,0.27382407,-0.39760336,-0.20571221,-0.3604194,0.012257894,0.026979234,0.415134,0.19060262,0.008002387,0.6522624,-0.12510511,0.24021403,-0.042370267,0.15489705,-0.22429402,0.47782388,-0.4806315,0.64919704,0.38248697,-0.16634114,0.30069986,-0.18280707,-0.43001303,0.58639866,0.051214855,0.3968506,0.487047,0.28807238,-0.060535006,0.40238932,-0.5521037,-0.38680014,-0.8381619,-0.08772617,-0.47098118,0.5547214,0.07446798,-0.12245348,0.123183675,-0.30297852,-0.1354031,-0.0132386945,-0.06457668,0.27000597,-0.58536786,0.05464893,0.05718072,-0.80067277,0.85026044,-0.45361328,0.11338467,0.38656956,-0.34072536,-0.19015163,0.24837834,-0.27495322,-0.25642565,-0.97558594,0.3586019,0.4686415,0.0030698776,0.23769464,0.61610246,-0.99576825,0.45906577,0.0039842394,-0.018277487,-0.10788303,0.3741684,-0.40437827,0.03664483,0.15420192,-0.108703434,-0.6366374,0.42262098,-0.11919488,0.111463755,0.019075181,0.33107504,0.19156817,0.19861476,0.09446716,0.06617228,-0.21466404,-0.5065816,-0.14289433,-0.06362745,-0.9848633,0.31698948,0.22691515,0.22739665,1.0955404,-0.52593994,0.15976292,-0.13178508,0.12479655,0.14453125,0.44436306,0.108076304,0.13701715,0.07576667,0.7734375,-0.03451877,-0.020507812,-0.7874892,-0.029468961,0.33018664,-0.7786458,0.18728638,0.8962131,-0.041988797,0.1017829,-0.1305775,0.44303384,-1.7764214,0.16495599,-0.004313151,-0.46261936,-0.5713433,-0.06589678,0.4373237,-0.34224448,0.4754516,-0.26089817,0.4685618,-0.8825141,0.03056166,0.118107185,0.06199222,0.7035048,0.7600369,0.41864693,-0.40915257,0.02693889,0.1772711,-0.2205196,0.13051182,0.16403538,0.5958116,-0.21511501,1.3568794,0.22617933,0.5940755,-0.12715997,0.36569554,0.07006624,-0.49419487,-1.1529405,-0.11952718,0.61935765,0.6362576,-0.82503253,-0.10203043,-0.66986763,-0.52723527,0.941135,-0.16062757,-0.7137858,-0.032993052,0.13745287,-0.12071737,-0.14208306,-0.77734375,-0.09138998,0.8524848,0.33402845,-0.10327869,0.39385307,-0.08488464,-0.295912,0.7813585,-0.30881077,-0.28212485,0.2807312,0.035202026,-0.53599715,0.79090714,-0.31554836,0.34565905,-0.335161,-0.76486546,-0.29710558,0.3186849,0.10480414,-0.107530385,-0.5170695,0.24695164,0.020490859,0.4159105,-0.27090624,0.3286404,-0.073913574,0.23812526,-0.13094966,0.1381429,-0.8048503,-0.038220722,-0.07714166,-0.1642456,-0.19545957,-0.5664605,-0.23721653,0.59543186,-0.48201498,0.3042806,0.12453037,-0.070387095,-0.395813,-0.23930019,0.3060574,-1.686849,-0.28312173,-0.5305447,-0.2411143,-0.31837294,-0.07207913,-0.44207084,0.47325304,-0.6603733,-0.8224284,-0.4262017,0.4409858,-0.2576565,0.31515843,-0.22012329,-0.15356162,-0.16803657,0.7546658,0.24249353,-0.22017415,-0.0281033,0.19662815,1.2692057,-0.23519558,0.7954644,0.20180935,-0.47931588,0.2139011,0.27608913,-0.119645864,0.13039143,-0.29315865,0.33392334,-1.0560439,0.14598761,-0.23276097,0.045173645,0.42114258,0.07685174,-0.38728842,-0.0949173,0.52107745,-0.10447693,-0.15891351,0.092043556,-0.47626412,0.24484931,0.22991773,-0.26605564,0.5221897,-0.11592441,-0.024277158,-0.6337077,0.09587606,0.09070757,0.10581122,-0.33111572,-0.12843831,-0.081842214,-0.85150826,-0.0931583,-0.3854845,0.21465386,0.26709664,0.73813206]}}]}]}
{"Collection":["my-coll",{"DeleteDocuments":{"doc_ids":[5]}}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":6,"doc":["ok1","{\"id\":\"ok1\",\"title\":\"The dog is on sofà\",\"section\":\"home\",\"number\":1}"]}}]}
{"Collection":["my-coll",{"Index":[6,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[6,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[6,6,{"IndexStringFilter":{"value":"home"}}]}]}
{"Collection":["my-coll",{"Index":[6,1,{"IndexString":{"field_length":2,"terms":{"dog":{"positions":[0]},"sofa":{"positions":[1]}}}}]}]}
{"Collection":["my-coll",{"Index":[6,5,{"IndexString":{"field_length":1,"terms":{"home":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[6,0,{"IndexEmbedding":{"value":[0.2172309,-0.306939,0.24758911,0.03833686,-0.07129499,-0.18205197,0.14820354,0.48293728,0.45298937,0.40196398,-0.0092230905,-0.87852645,0.19251844,0.7051595,0.11478,0.09089491,0.2774387,0.55807835,-0.099544525,0.37197536,-0.06405512,-0.42599827,0.33102375,-0.042899236,-0.020480685,0.14285956,0.24987115,-0.07006158,-0.17411634,-0.8897569,0.1506958,-0.57766384,0.03608534,-0.09964667,0.5076226,-0.06781006,0.18414646,0.38194445,-0.16083442,0.4578315,0.16012233,0.100862294,0.055704754,-0.16312663,0.17900933,0.3106893,-0.025821261,-0.7837999,0.68098956,-0.41402182,-0.48620307,0.095581904,0.09372626,-0.13031006,0.43706596,0.3263143,0.93207467,0.010203044,-0.23934259,0.23452419,0.30187988,0.85215926,-0.9352214,0.7618544,0.5241835,-0.14456517,-0.5089247,-0.05703142,0.9066026,0.42349583,0.19181654,-0.11531915,-0.06488376,-0.26152208,0.5218777,-0.17599148,-0.1258884,0.37618002,-0.27567038,0.081448026,-0.37601724,0.09276581,-0.06562635,-0.18582661,-0.23811848,-0.09690433,0.2799208,-0.54797363,-0.2940945,0.45003256,-0.6713867,-0.0814921,-0.51295304,-0.41124132,-0.29163954,-0.36764866,-0.0116136335,-0.44725206,0.0066452026,1.0361328,0.13201396,0.16207208,0.43907335,-0.81114364,0.31863064,0.335829,0.2620093,0.41878256,-0.073132835,0.27382407,-0.39760336,-0.20571221,-0.3604194,0.012257894,0.026979234,0.415134,0.19060262,0.008002387,0.6522624,-0.12510511,0.24021403,-0.042370267,0.15489705,-0.22429402,0.47782388,-0.4806315,0.64919704,0.38248697,-0.16634114,0.30069986,-0.18280707,-0.43001303,0.58639866,0.051214855,0.3968506,0.487047,0.28807238,-0.060535006,0.40238932,-0.5521037,-0.38680014,-0.8381619,-0.08772617,-0.47098118,0.5547214,0.07446798,-0.12245348,0.123183675,-0.30297852,-0.1354031,-0.0132386945,-0.06457668,0.27000597,-0.58536786,0.05464893,0.05718072,-0.80067277,0.85026044,-0.45361328,0.11338467,0.38656956,-0.34072536,-0.19015163,0.24837834,-0.27495322,-0.25642565,-0.97558594,0.3586019,0.4686415,0.0030698776,0.23769464,0.61610246,-0.99576825,0.45906577,0.0039842394,-0.018277487,-0.10788303,0.3741684,-0.40437827,0.03664483,0.15420192,-0.108703434,-0.6366374,0.42262098,-0.11919488,0.111463755,0.019075181,0.33107504,0.19156817,0.19861476,0.09446716,0.06617228,-0.21466404,-0.5065816,-0.14289433,-0.06362745,-0.9848633,0.31698948,0.22691515,0.22739665,1.0955404,-0.52593994,0.15976292,-0.13178508,0.12479655,0.14453125,0.44436306,0.108076304,0.13701715,0.07576667,0.7734375,-0.03451877,-0.020507812,-0.7874892,-0.029468961,0.33018664,-0.7786458,0.18728638,0.8962131,-0.041988797,0.1017829,-0.1305775,0.44303384,-1.7764214,0.16495599,-0.004313151,-0.46261936,-0.5713433,-0.06589678,0.4373237,-0.34224448,0.4754516,-0.26089817,0.4685618,-0.8825141,0.03056166,0.118107185,0.06199222,0.7035048,0.7600369,0.41864693,-0.40915257,0.02693889,0.1772711,-0.2205196,0.13051182,0.16403538,0.5958116,-0.21511501,1.3568794,0.22617933,0.5940755,-0.12715997,0.36569554,0.07006624,-0.49419487,-1.1529405,-0.11952718,0.61935765,0.6362576,-0.82503253,-0.10203043,-0.66986763,-0.52723527,0.941135,-0.16062757,-0.7137858,-0.032993052,0.13745287,-0.12071737,-0.14208306,-0.77734375,-0.09138998,0.8524848,0.33402845,-0.10327869,0.39385307,-0.08488464,-0.295912,0.7813585,-0.30881077,-0.28212485,0.2807312,0.035202026,-0.53599715,0.79090714,-0.31554836,0.34565905,-0.335161,-0.76486546,-0.29710558,0.3186849,0.10480414,-0.107530385,-0.5170695,0.24695164,0.020490859,0.4159105,-0.27090624,0.3286404,-0.073913574,0.23812526,-0.13094966,0.1381429,-0.8048503,-0.038220722,-0.07714166,-0.1642456,-0.19545957,-0.5664605,-0.23721653,0.59543186,-0.48201498,0.3042806,0.12453037,-0.070387095,-0.395813,-0.23930019,0.3060574,-1.686849,-0.28312173,-0.5305447,-0.2411143,-0.31837294,-0.07207913,-0.44207084,0.47325304,-0.6603733,-0.8224284,-0.4262017,0.4409858,-0.2576565,0.31515843,-0.22012329,-0.15356162,-0.16803657,0.7546658,0.24249353,-0.22017415,-0.0281033,0.19662815,1.2692057,-0.23519558,0.7954644,0.20180935,-0.47931588,0.2139011,0.27608913,-0.119645864,0.13039143,-0.29315865,0.33392334,-1.0560439,0.14598761,-0.23276097,0.045173645,0.42114258,0.07685174,-0.38728842,-0.0949173,0.52107745,-0.10447693,-0.15891351,0.092043556,-0.47626412,0.24484931,0.22991773,-0.26605564,0.5221897,-0.11592441,-0.024277158,-0.6337077,0.09587606,0.09070757,0.10581122,-0.33111572,-0.12843831,-0.081842214,-0.85150826,-0.0931583,-0.3854845,0.21465386,0.26709664,0.73813206]}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":6,"doc":["ok6","{\"id\":\"ok6\",\"title\":\"The dog is on sofà\",\"section\":\"home\",\"number\":1}"]}}]}
{"Collection":["my-coll",{"Index":[6,6,{"IndexStringFilter":{"value":"home"}}]}]}
{"Collection":["my-coll",{"Index":[6,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[6,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[6,5,{"IndexString":{"field_length":1,"terms":{"home":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[6,1,{"IndexString":{"field_length":2,"terms":{"sofa":{"positions":[1]},"dog":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[6,0,{"IndexEmbedding":{"value":[0.2172309,-0.306939,0.24758911,0.03833686,-0.07129499,-0.18205197,0.14820354,0.48293728,0.45298937,0.40196398,-0.0092230905,-0.87852645,0.19251844,0.7051595,0.11478,0.09089491,0.2774387,0.55807835,-0.099544525,0.37197536,-0.06405512,-0.42599827,0.33102375,-0.042899236,-0.020480685,0.14285956,0.24987115,-0.07006158,-0.17411634,-0.8897569,0.1506958,-0.57766384,0.03608534,-0.09964667,0.5076226,-0.06781006,0.18414646,0.38194445,-0.16083442,0.4578315,0.16012233,0.100862294,0.055704754,-0.16312663,0.17900933,0.3106893,-0.025821261,-0.7837999,0.68098956,-0.41402182,-0.48620307,0.095581904,0.09372626,-0.13031006,0.43706596,0.3263143,0.93207467,0.010203044,-0.23934259,0.23452419,0.30187988,0.85215926,-0.9352214,0.7618544,0.5241835,-0.14456517,-0.5089247,-0.05703142,0.9066026,0.42349583,0.19181654,-0.11531915,-0.06488376,-0.26152208,0.5218777,-0.17599148,-0.1258884,0.37618002,-0.27567038,0.081448026,-0.37601724,0.09276581,-0.06562635,-0.18582661,-0.23811848,-0.09690433,0.2799208,-0.54797363,-0.2940945,0.45003256,-0.6713867,-0.0814921,-0.51295304,-0.41124132,-0.29163954,-0.36764866,-0.0116136335,-0.44725206,0.0066452026,1.0361328,0.13201396,0.16207208,0.43907335,-0.81114364,0.31863064,0.335829,0.2620093,0.41878256,-0.073132835,0.27382407,-0.39760336,-0.20571221,-0.3604194,0.012257894,0.026979234,0.415134,0.19060262,0.008002387,0.6522624,-0.12510511,0.24021403,-0.042370267,0.15489705,-0.22429402,0.47782388,-0.4806315,0.64919704,0.38248697,-0.16634114,0.30069986,-0.18280707,-0.43001303,0.58639866,0.051214855,0.3968506,0.487047,0.28807238,-0.060535006,0.40238932,-0.5521037,-0.38680014,-0.8381619,-0.08772617,-0.47098118,0.5547214,0.07446798,-0.12245348,0.123183675,-0.30297852,-0.1354031,-0.0132386945,-0.06457668,0.27000597,-0.58536786,0.05464893,0.05718072,-0.80067277,0.85026044,-0.45361328,0.11338467,0.38656956,-0.34072536,-0.19015163,0.24837834,-0.27495322,-0.25642565,-0.97558594,0.3586019,0.4686415,0.0030698776,0.23769464,0.61610246,-0.99576825,0.45906577,0.0039842394,-0.018277487,-0.10788303,0.3741684,-0.40437827,0.03664483,0.15420192,-0.108703434,-0.6366374,0.42262098,-0.11919488,0.111463755,0.019075181,0.33107504,0.19156817,0.19861476,0.09446716,0.06617228,-0.21466404,-0.5065816,-0.14289433,-0.06362745,-0.9848633,0.31698948,0.22691515,0.22739665,1.0955404,-0.52593994,0.15976292,-0.13178508,0.12479655,0.14453125,0.44436306,0.108076304,0.13701715,0.07576667,0.7734375,-0.03451877,-0.020507812,-0.7874892,-0.029468961,0.33018664,-0.7786458,0.18728638,0.8962131,-0.041988797,0.1017829,-0.1305775,0.44303384,-1.7764214,0.16495599,-0.004313151,-0.46261936,-0.5713433,-0.06589678,0.4373237,-0.34224448,0.4754516,-0.26089817,0.4685618,-0.8825141,0.03056166,0.118107185,0.06199222,0.7035048,0.7600369,0.41864693,-0.40915257,0.02693889,0.1772711,-0.2205196,0.13051182,0.16403538,0.5958116,-0.21511501,1.3568794,0.22617933,0.5940755,-0.12715997,0.36569554,0.07006624,-0.49419487,-1.1529405,-0.11952718,0.61935765,0.6362576,-0.82503253,-0.10203043,-0.66986763,-0.52723527,0.941135,-0.16062757,-0.7137858,-0.032993052,0.13745287,-0.12071737,-0.14208306,-0.77734375,-0.09138998,0.8524848,0.33402845,-0.10327869,0.39385307,-0.08488464,-0.295912,0.7813585,-0.30881077,-0.28212485,0.2807312,0.035202026,-0.53599715,0.79090714,-0.31554836,0.34565905,-0.335161,-0.76486546,-0.29710558,0.3186849,0.10480414,-0.107530385,-0.5170695,0.24695164,0.020490859,0.4159105,-0.27090624,0.3286404,-0.073913574,0.23812526,-0.13094966,0.1381429,-0.8048503,-0.038220722,-0.07714166,-0.1642456,-0.19545957,-0.5664605,-0.23721653,0.59543186,-0.48201498,0.3042806,0.12453037,-0.070387095,-0.395813,-0.23930019,0.3060574,-1.686849,-0.28312173,-0.5305447,-0.2411143,-0.31837294,-0.07207913,-0.44207084,0.47325304,-0.6603733,-0.8224284,-0.4262017,0.4409858,-0.2576565,0.31515843,-0.22012329,-0.15356162,-0.16803657,0.7546658,0.24249353,-0.22017415,-0.0281033,0.19662815,1.2692057,-0.23519558,0.7954644,0.20180935,-0.47931588,0.2139011,0.27608913,-0.119645864,0.13039143,-0.29315865,0.33392334,-1.0560439,0.14598761,-0.23276097,0.045173645,0.42114258,0.07685174,-0.38728842,-0.0949173,0.52107745,-0.10447693,-0.15891351,0.092043556,-0.47626412,0.24484931,0.22991773,-0.26605564,0.5221897,-0.11592441,-0.024277158,-0.6337077,0.09587606,0.09070757,0.10581122,-0.33111572,-0.12843831,-0.081842214,-0.85150826,-0.0931583,-0.3854845,0.21465386,0.26709664,0.73813206]}}]}]}
{"Collection":["my-coll",{"InsertDocument":{"doc_id":7,"doc":["ok7","{\"id\":\"ok7\",\"title\":\"The dog is on sofà\",\"section\":\"home\",\"number\":1}"]}}]}
{"Collection":["my-coll",{"Index":[7,6,{"IndexStringFilter":{"value":"home"}}]}]}
{"Collection":["my-coll",{"Index":[7,2,{"IndexStringFilter":{"value":"The dog is on sofà"}}]}]}
{"Collection":["my-coll",{"Index":[7,3,{"IndexNumber":{"value":[1,0,0,0,1]}}]}]}
{"Collection":["my-coll",{"Index":[7,5,{"IndexString":{"field_length":1,"terms":{"home":{"positions":[0]}}}}]}]}
{"Collection":["my-coll",{"Index":[7,1,{"IndexString":{"field_length":2,"terms":{"dog":{"positions":[0]},"sofa":{"positions":[1]}}}}]}]}
{"Collection":["my-coll",{"Index":[7,0,{"IndexEmbedding":{"value":[0.2172309,-0.306939,0.24758911,0.03833686,-0.07129499,-0.18205197,0.14820354,0.48293728,0.45298937,0.40196398,-0.0092230905,-0.87852645,0.19251844,0.7051595,0.11478,0.09089491,0.2774387,0.55807835,-0.099544525,0.37197536,-0.06405512,-0.42599827,0.33102375,-0.042899236,-0.020480685,0.14285956,0.24987115,-0.07006158,-0.17411634,-0.8897569,0.1506958,-0.57766384,0.03608534,-0.09964667,0.5076226,-0.06781006,0.18414646,0.38194445,-0.16083442,0.4578315,0.16012233,0.100862294,0.055704754,-0.16312663,0.17900933,0.3106893,-0.025821261,-0.7837999,0.68098956,-0.41402182,-0.48620307,0.095581904,0.09372626,-0.13031006,0.43706596,0.3263143,0.93207467,0.010203044,-0.23934259,0.23452419,0.30187988,0.85215926,-0.9352214,0.7618544,0.5241835,-0.14456517,-0.5089247,-0.05703142,0.9066026,0.42349583,0.19181654,-0.11531915,-0.06488376,-0.26152208,0.5218777,-0.17599148,-0.1258884,0.37618002,-0.27567038,0.081448026,-0.37601724,0.09276581,-0.06562635,-0.18582661,-0.23811848,-0.09690433,0.2799208,-0.54797363,-0.2940945,0.45003256,-0.6713867,-0.0814921,-0.51295304,-0.41124132,-0.29163954,-0.36764866,-0.0116136335,-0.44725206,0.0066452026,1.0361328,0.13201396,0.16207208,0.43907335,-0.81114364,0.31863064,0.335829,0.2620093,0.41878256,-0.073132835,0.27382407,-0.39760336,-0.20571221,-0.3604194,0.012257894,0.026979234,0.415134,0.19060262,0.008002387,0.6522624,-0.12510511,0.24021403,-0.042370267,0.15489705,-0.22429402,0.47782388,-0.4806315,0.64919704,0.38248697,-0.16634114,0.30069986,-0.18280707,-0.43001303,0.58639866,0.051214855,0.3968506,0.487047,0.28807238,-0.060535006,0.40238932,-0.5521037,-0.38680014,-0.8381619,-0.08772617,-0.47098118,0.5547214,0.07446798,-0.12245348,0.123183675,-0.30297852,-0.1354031,-0.0132386945,-0.06457668,0.27000597,-0.58536786,0.05464893,0.05718072,-0.80067277,0.85026044,-0.45361328,0.11338467,0.38656956,-0.34072536,-0.19015163,0.24837834,-0.27495322,-0.25642565,-0.97558594,0.3586019,0.4686415,0.0030698776,0.23769464,0.61610246,-0.99576825,0.45906577,0.0039842394,-0.018277487,-0.10788303,0.3741684,-0.40437827,0.03664483,0.15420192,-0.108703434,-0.6366374,0.42262098,-0.11919488,0.111463755,0.019075181,0.33107504,0.19156817,0.19861476,0.09446716,0.06617228,-0.21466404,-0.5065816,-0.14289433,-0.06362745,-0.9848633,0.31698948,0.22691515,0.22739665,1.0955404,-0.52593994,0.15976292,-0.13178508,0.12479655,0.14453125,0.44436306,0.108076304,0.13701715,0.07576667,0.7734375,-0.03451877,-0.020507812,-0.7874892,-0.029468961,0.33018664,-0.7786458,0.18728638,0.8962131,-0.041988797,0.1017829,-0.1305775,0.44303384,-1.7764214,0.16495599,-0.004313151,-0.46261936,-0.5713433,-0.06589678,0.4373237,-0.34224448,0.4754516,-0.26089817,0.4685618,-0.8825141,0.03056166,0.118107185,0.06199222,0.7035048,0.7600369,0.41864693,-0.40915257,0.02693889,0.1772711,-0.2205196,0.13051182,0.16403538,0.5958116,-0.21511501,1.3568794,0.22617933,0.5940755,-0.12715997,0.36569554,0.07006624,-0.49419487,-1.1529405,-0.11952718,0.61935765,0.6362576,-0.82503253,-0.10203043,-0.66986763,-0.52723527,0.941135,-0.16062757,-0.7137858,-0.032993052,0.13745287,-0.12071737,-0.14208306,-0.77734375,-0.09138998,0.8524848,0.33402845,-0.10327869,0.39385307,-0.08488464,-0.295912,0.7813585,-0.30881077,-0.28212485,0.2807312,0.035202026,-0.53599715,0.79090714,-0.31554836,0.34565905,-0.335161,-0.76486546,-0.29710558,0.3186849,0.10480414,-0.107530385,-0.5170695,0.24695164,0.020490859,0.4159105,-0.27090624,0.3286404,-0.073913574,0.23812526,-0.13094966,0.1381429,-0.8048503,-0.038220722,-0.07714166,-0.1642456,-0.19545957,-0.5664605,-0.23721653,0.59543186,-0.48201498,0.3042806,0.12453037,-0.070387095,-0.395813,-0.23930019,0.3060574,-1.686849,-0.28312173,-0.5305447,-0.2411143,-0.31837294,-0.07207913,-0.44207084,0.47325304,-0.6603733,-0.8224284,-0.4262017,0.4409858,-0.2576565,0.31515843,-0.22012329,-0.15356162,-0.16803657,0.7546658,0.24249353,-0.22017415,-0.0281033,0.19662815,1.2692057,-0.23519558,0.7954644,0.20180935,-0.47931588,0.2139011,0.27608913,-0.119645864,0.13039143,-0.29315865,0.33392334,-1.0560439,0.14598761,-0.23276097,0.045173645,0.42114258,0.07685174,-0.38728842,-0.0949173,0.52107745,-0.10447693,-0.15891351,0.092043556,-0.47626412,0.24484931,0.22991773,-0.26605564,0.5221897,-0.11592441,-0.024277158,-0.6337077,0.09587606,0.09070757,0.10581122,-0.33111572,-0.12843831,-0.081842214,-0.85150826,-0.0931583,-0.3854845,0.21465386,0.26709664,0.73813206]}}]}]}"#;

    let commands = a
        .split('\n')
        .filter_map(|s| {
            if s.contains("InsertDocument") {
                return None;
            }
            Some(serde_json::from_str::<WriteOperation>(s).unwrap())
        })
        .collect::<Vec<_>>();

    let _ = tracing_subscriber::fmt::try_init();
    let mut config = create_oramacore_config();
    config.reader_side.config.insert_batch_commit_size = 1_000_000;
    config.writer_side.config.insert_batch_commit_size = 1_000_000;

    let (_, read_side) = create(config.clone()).await?;

    for (offset, command) in commands.into_iter().enumerate() {
        let offset = Offset(offset as u64);
        read_side.update((offset, command)).await?;
    }

    read_side.commit().await?;

    Ok(())
}
